<template>
  <div class="built-in-manager">
    <div class="section-header">
      <el-radio-group v-model="type" class="select-type">
        <el-radio
          v-for="item in typeList"
          :key="item.value"
          :label="item.value"
          class="permission-type"
          border
        >
          <span>{{ item.label }}</span>
        </el-radio>
      </el-radio-group>
      <div>
        <el-button type="primary" size="small" icon="el-icon-plus" @click="handleAdd">
          {{ $t('Base.add') }}
        </el-button>
      </div>
    </div>
    <el-table v-show="type === 'all'" :data="allTableData" v-loading.lock="lockTable">
      <el-table-column v-if="false" type="expand"></el-table-column>
      <el-table-column prop="permission" label="Permission"></el-table-column>
      <el-table-column prop="action" label="Action"></el-table-column>
      <el-table-column prop="topic" label="Topic"></el-table-column>
      <el-table-column :label="$t('Base.operation')">
        <template slot-scope="{ row, $index }">
          <el-button size="mini" @click="handleEdit(row, $index)">
            {{ $t('Base.edit') }}
          </el-button>
          <el-button size="mini" @click="handleDelete(row, $index)">
            {{ $t('Base.delete') }}
          </el-button>
        </template>
      </el-table-column>
    </el-table>
    <el-table v-show="type !== 'all'" :data="tableData" v-loading.lock="lockTable">
      <el-table-column type="expand">
        <template slot-scope="{ row }">
          <el-table :data="row.rules">
            <el-table-column prop="permission" label="Permission" min-width="80px">
            </el-table-column>
            <el-table-column prop="action" label="Action" min-width="80px"></el-table-column>
            <el-table-column prop="topic" label="Topic"></el-table-column>
          </el-table>
        </template>
      </el-table-column>
      <el-table-column
        v-if="type === 'clientid'"
        prop="clientid"
        label="ClientID"
      ></el-table-column>
      <el-table-column
        v-else-if="type === 'username'"
        prop="username"
        label="Username"
      ></el-table-column>
      <el-table-column prop="rules" :label="$t('Auth.permissionCount')">
        <template slot-scope="{ row }">
          {{ row.rules.length }}
        </template>
      </el-table-column>
      <el-table-column :label="$t('Base.operation')">
        <template slot-scope="{ row }">
          <el-button size="mini" @click="handleEdit(row)">
            {{ $t('Base.edit') }}
          </el-button>
          <el-button size="mini" @click="handleDelete(row)">
            {{ $t('Base.delete') }}
          </el-button>
        </template>
      </el-table-column>
    </el-table>
    <el-dialog :title="isEdit ? $t('Base.edit') : $t('Base.add')" :visible.sync="dialogVisible">
      <el-form ref="recordForm" :model="record" :rules="getRules()">
        <template v-if="type === 'all'">
          <el-form-item prop="permission" label="Permission">
            <el-select v-model="record.permission">
              <el-option value="allow" label="Allow"></el-option>
              <el-option value="deny" label="Deny"></el-option>
            </el-select>
          </el-form-item>
          <el-form-item prop="action" label="Action">
            <el-select v-model="record.action">
              <el-option value="publish" label="Publish"></el-option>
              <el-option value="subscribe" label="Subscribe"></el-option>
              <el-option value="all" label="All"></el-option>
            </el-select>
          </el-form-item>
          <el-form-item prop="topic" label="Topic">
            <el-input v-model="record.topic"></el-input>
          </el-form-item>
        </template>
        <template v-else>
          <el-form-item v-if="type === 'clientid'" prop="clientid" label="ClientID">
            <el-input v-model="record.clientid" :disabled="isEdit"></el-input>
          </el-form-item>
          <el-form-item v-else-if="type === 'username'" prop="username" label="Username">
            <el-input v-model="record.username"></el-input>
          </el-form-item>
          <el-form-item label="Permissions">
            <el-table class="form-table" :data="rulesData" size="mini">
              <el-table-column prop="permission" label="Permission">
                <template slot-scope="{ row }">
                  <el-select v-model="row.permission">
                    <el-option value="allow" label="Allow"></el-option>
                    <el-option value="deny" label="Deny"></el-option>
                  </el-select>
                </template>
              </el-table-column>
              <el-table-column prop="action" label="Action">
                <template slot-scope="{ row }">
                  <el-select v-model="row.action">
                    <el-option value="publish" label="Publish"></el-option>
                    <el-option value="subscribe" label="Subscribe"></el-option>
                    <el-option value="all" label="All"></el-option>
                  </el-select>
                </template>
              </el-table-column>
              <el-table-column prop="topic" label="Topic">
                <template slot-scope="{ row }">
                  <el-input v-model="row.topic"></el-input>
                </template>
              </el-table-column>
              <el-table-column align="right" max-width="160px">
                <a href="javascript:;" slot="header" class="btn" @click="addColumn">
                  {{ $t('Base.add') }}
                </a>
                <template slot-scope="{ row, $index }">
                  <a href="javascript:;" class="btn" @click="handleUp(row, $index)">
                    {{ $t('Base.up') }}
                  </a>
                  <a href="javascript:;" class="btn" @click="handleDown(row, $index)">
                    {{ $t('Base.down') }}
                  </a>
                  <a href="javascript:;" class="btn" @click="deleteItem(row, $index)">
                    {{ $t('Base.delete') }}
                  </a>
                </template>
              </el-table-column>
            </el-table>
          </el-form-item>
        </template>
      </el-form>
      <div slot="footer" class="dialog-align-footer">
        <el-button plain size="small" @click="dialogVisible = false">
          {{ $t('Base.cancel') }}
        </el-button>
        <el-button type="primary" size="small" @click="handleSubmit">
          {{ isEdit ? $t('Base.update') : $t('Base.add') }}
        </el-button>
      </div>
    </el-dialog>
  </div>
</template>

<script>
import { defineComponent, reactive, ref, watch } from '@vue/composition-api'
import {
  loadBuiltInDatabaseData,
  createBuiltInDatabaseData,
  deleteBuiltInDatabaseData,
  updateBuiltInDatabaseData,
  updateAllBuiltInDatabaseData,
} from '@/api/auth'
import _ from 'lodash'

export default defineComponent({
  name: 'BuiltInManager',
  setup() {
    const type = ref('clientid')
    const lockTable = ref(false)
    const typeList = [
      {
        label: 'ClientID',
        value: 'clientid',
      },
      {
        label: 'Username',
        value: 'username',
      },
      {
        label: 'All',
        value: 'all',
      },
    ]
    const tableData = ref([])
    const allTableData = ref([])
    const rulesData = ref([])
    const record = reactive({
      clientid: '',
      username: '',
      rules: [],
      permission: 'allow',
      action: 'publish',
      topic: '',
    })
    const dialogVisible = ref(false)
    const isEdit = ref(false)
    const editIndex = ref(0)
    const getRules = function () {
      return {
        clientid: [
          { required: true, message: this.$t('Auth.pleaseEnterClientID'), trigger: 'blur' },
        ],
        username: [
          { required: true, message: this.$t('Auth.pleaseEnterUsername'), trigger: 'blur' },
        ],
        permission: [
          { required: true, message: this.$t('Auth.pleaseSelectPermission'), trigger: 'blur' },
        ],
        action: [{ required: true, message: this.$t('Auth.pleaseSelectAction'), trigger: 'blur' }],
        topic: [{ required: true, message: this.$t('Auth.pleaseEnterTopic'), trigger: 'blur' }],
      }
    }
    watch(type, () => {
      loadData(true)
    })
    watch(dialogVisible, (val) => {
      if (!val) {
        handleCancel()
      }
    })
    const loadData = async (reload) => {
      if (reload) {
        tableData.value = []
      }
      lockTable.value = true
      const res = await loadBuiltInDatabaseData(type.value).catch(() => {
        lockTable.value = false
      })
      if (type.value === 'all') {
        allTableData.value = res[0].rules
      } else {
        tableData.value = res
      }
      lockTable.value = false
    }
    loadData()
    const handleAdd = function () {
      dialogVisible.value = true
      isEdit.value = false
      if (this.$refs.recordForm) {
        setTimeout(this.$refs.recordForm.clearValidate, 10)
      }
    }
    const handleCancel = function () {
      dialogVisible.value = false
      record.clientid = ''
      record.username = ''
      record.permission = 'allow'
      record.action = 'publish'
      record.topic = ''
      record.rules = []
      rulesData.value = []
    }
    const addColumn = () => {
      rulesData.value.push({
        permission: 'allow',
        action: 'publish',
        topic: '',
      })
    }
    const deleteItem = (row, index) => {
      rulesData.value.splice(index, 1)
    }
    const handleSubmit = function () {
      this.$refs.recordForm.validate(async (valid) => {
        if (!valid) {
          return
        }
        const key = type.value
        const data = {}
        if (key !== 'all') {
          data[key] = record[key]
          data.rules = rulesData.value
          if (!isEdit.value) {
            await createBuiltInDatabaseData(type.value, [data])
            this.$message.success(this.$t('Base.createSuccess'))
          } else {
            await updateBuiltInDatabaseData(type.value, data[type.value], data)
            this.$message.success(this.$t('Base.updateSuccess'))
          }
        } else {
          data.permission = record.permission
          data.action = record.action
          data.topic = record.topic
          const rules = _.cloneDeep(allTableData.value)
          if (!isEdit.value) {
            rules.push(data)
          } else {
            rules.splice(editIndex.value, 1, data)
          }
          await updateAllBuiltInDatabaseData({
            rules,
          })
        }
        dialogVisible.value = false
        loadData()
      })
    }
    const handleDelete = function (row, index) {
      this.$confirm(this.$t('General.confirmDelete'), {
        confirmButtonText: this.$t('Base.confirm'),
        cancelButtonText: this.$t('Base.cancel'),
        type: 'warning',
      })
        .then(async () => {
          if (type.value !== 'all') {
            await deleteBuiltInDatabaseData(type.value, row[type.value]).catch(() => {})
          } else {
            const rules = _.cloneDeep(allTableData.value)
            rules.splice(index, 1)
            await updateAllBuiltInDatabaseData({
              rules,
            })
          }
          loadData()
        })
        .catch(() => {})
    }
    const handleEdit = function (row, index) {
      dialogVisible.value = true
      isEdit.value = true
      editIndex.value = 0
      if (type.value !== 'all') {
        const key = type.value
        record[key] = row[key]
        rulesData.value = row.rules
      } else {
        editIndex.value = index
        record.permission = row.permission
        record.action = row.action
        record.topic = row.topic
      }
    }
    const swapArray = (arr, fromIndex, toIndex) => {
      arr[toIndex] = arr.splice(fromIndex, 1, arr[toIndex])[0]
      return arr
    }
    const handleUp = (row, index) => {
      if (index === 0) {
        return
      }
      swapArray(rulesData.value, index, index - 1)
    }
    const handleDown = (row, index) => {
      if (index === rulesData.value.length - 1) {
        return
      }
      swapArray(rulesData.value, index, index + 1)
    }
    return {
      type,
      typeList,
      record,
      dialogVisible,
      lockTable,
      tableData,
      allTableData,
      rulesData,
      isEdit,
      getRules,
      handleAdd,
      addColumn,
      deleteItem,
      handleSubmit,
      handleDelete,
      handleEdit,
      handleUp,
      handleDown,
    }
  },
})
</script>

<style lang="scss">
.built-in-manager {
  .el-radio.is-bordered {
    margin-top: 0px;
    width: 100px;
  }
  .el-table__expanded-cell {
    padding: 24px 48px;
    .el-table {
      border: 0px;
    }
  }
  .form-table {
    .cell {
      .btn + .btn {
        margin-left: 5px;
      }
    }
  }
}
</style>
